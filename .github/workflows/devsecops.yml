name: DevSecOps CI/CD Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  devsecops:
    runs-on: ubuntu-latest

    steps:
    # =====================================
    # 1. CHECKOUT
    # =====================================
    - name: Checkout repository
      uses: actions/checkout@v4

    # =====================================
    # 2. SETUP ENVIRONMENT
    # =====================================
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20

    # =====================================
    # 3. CREATE ENV FILES
    # =====================================
    - name: Create env files for Docker Compose
      run: |
        cp backend/users-service/.env.example backend/users-service/.env
        cp backend/academic-service/.env.example backend/academic-service/.env
        cp backend/api-gateway/.env.example backend/api-gateway/.env
        cp frontend/.env.example frontend/.env

        echo "DB_HOST=${{ secrets.USERS_DB_HOST }}" >> backend/users-service/.env
        echo "DB_USER=${{ secrets.USERS_DB_USER }}" >> backend/users-service/.env
        echo "DB_PASSWORD=${{ secrets.USERS_DB_PASSWORD }}" >> backend/users-service/.env

        echo "DB_HOST=${{ secrets.ACADEMIC_DB_HOST }}" >> backend/academic-service/.env
        echo "DB_USER=${{ secrets.ACADEMIC_DB_USER }}" >> backend/academic-service/.env
        echo "DB_PASSWORD=${{ secrets.ACADEMIC_DB_PASSWORD }}" >> backend/academic-service/.env

        echo "USERS_SERVICE_URL=http://users-service:3001" >> backend/api-gateway/.env
        echo "ACADEMIC_SERVICE_URL=http://academic-service:3002" >> backend/api-gateway/.env
        echo "VITE_API_URL=http://api-gateway:3000" >> frontend/.env

    # =====================================
    # 4. CODE QUALITY (LINT)
    # =====================================
    - name: Lint users-service
      run: |
        cd backend/users-service
        npm ci
        npm run lint

    - name: Lint academic-service
      run: |
        cd backend/academic-service
        npm ci
        npm run lint

    - name: Lint api-gateway
      run: |
        cd backend/api-gateway
        npm ci
        npm run lint

    - name: Lint frontend
      run: |
        cd frontend
        npm ci
        npm run lint

    # =====================================
    # 5. TESTING
    # =====================================
    - name: Run backend tests
      run: |
        cd backend/users-service && npm test
        cd ../academic-service && npm test
        cd ../api-gateway && npm test

    - name: Run frontend tests
      run: |
        cd frontend && npm test

    # =====================================
    # 6. SCA - Dependency Security
    # =====================================
    - name: Dependency audit (all services)
      run: |
        cd backend/users-service && npm audit --audit-level=critical
        cd ../academic-service && npm audit --audit-level=critical
        cd ../api-gateway && npm audit --audit-level=critical
        cd ../../frontend && npm audit --audit-level=critical

    # =====================================
    # 7. SAST - SEMGREP
    # =====================================
    - name: Install Semgrep
      run: |
        python3 -m pip install --upgrade pip
        pip install semgrep

    - name: Run Semgrep
      run: semgrep --config=auto --error

    # =====================================
    # 8. BUILD DOCKER IMAGES
    # =====================================
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker images
      run: docker compose -f backend/docker-compose.yml build

    - name: Tag Docker images
      run: |
        TAG=${{ github.sha }}
        docker tag users-service users-service:$TAG || true
        docker tag academic-service academic-service:$TAG || true
        docker tag api-gateway api-gateway:$TAG || true

    # =====================================
    # 9. CONTAINER SECURITY - TRIVY
    # =====================================
    - name: Scan users-service image
      uses: aquasecurity/trivy-action@0.20.0
      with:
        image-ref: users-service
        severity: CRITICAL,HIGH
        exit-code: 1

    - name: Scan academic-service image
      uses: aquasecurity/trivy-action@0.20.0
      with:
        image-ref: academic-service
        severity: CRITICAL,HIGH
        exit-code: 1

    - name: Scan api-gateway image
      uses: aquasecurity/trivy-action@0.20.0
      with:
        image-ref: api-gateway
        severity: CRITICAL,HIGH
        exit-code: 1

    # =====================================
    # 10. DEPLOY (STAGING LOCAL)
    # =====================================
    - name: Deploy services (docker-compose)
      run: |
        docker compose -f backend/docker-compose.yml up -d
        sleep 20

    - name: Health Check API Gateway
      run: curl -f http://localhost:3000/health

    - name: Shutdown services
      if: always()
      run: docker compose -f backend/docker-compose.yml down || true